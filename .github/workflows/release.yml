# ABOUTME: Builds a signed, notarized Claide.dmg on tag push and publishes to GitHub Releases.
# ABOUTME: Updates Homebrew cask and Sparkle appcast in the tap repo after release.

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 2026.2.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 30
    env:
      RELEASE_VERSION: ${{ inputs.version || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "$RELEASE_VERSION" ]; then
            echo "version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          else
            TAG="${GITHUB_REF_NAME#v}"
            echo "version=$TAG" >> "$GITHUB_OUTPUT"
          fi

      - name: Install tools
        run: brew install xcodegen sparkle

      - name: Import Developer ID certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          P12_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 16)"

          echo "$P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Archive
        run: |
          xcodebuild archive \
            -scheme Claide \
            -configuration Release \
            -destination 'platform=macOS' \
            -archivePath build/Claide.xcarchive \
            DEVELOPMENT_TEAM=7G4UQW35EL \
            CODE_SIGN_STYLE=Manual \
            "CODE_SIGN_IDENTITY=Developer ID Application" \
            | tail -5

      - name: Export
        run: |
          xcodebuild -exportArchive \
            -archivePath build/Claide.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export \
            | tail -5

      - name: Verify signature
        run: |
          codesign --verify --deep --strict build/export/Claide.app
          codesign -dvv build/export/Claide.app 2>&1 | grep "Authority"

      - name: Create DMG
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          hdiutil create \
            -volname "Claide" \
            -srcfolder build/export/Claide.app \
            -ov \
            -format UDZO \
            "build/Claide-${VERSION}.dmg"

      - name: Notarize DMG
        env:
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER: ${{ secrets.NOTARY_ISSUER }}
          NOTARY_KEY_P8: ${{ secrets.NOTARY_KEY_P8 }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          KEY_PATH="$RUNNER_TEMP/notary-key.p8"
          echo "$NOTARY_KEY_P8" > "$KEY_PATH"

          xcrun notarytool submit \
            "build/Claide-${VERSION}.dmg" \
            --key-id "$NOTARY_KEY_ID" \
            --issuer "$NOTARY_ISSUER" \
            --key "$KEY_PATH" \
            --wait

          xcrun stapler staple "build/Claide-${VERSION}.dmg"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/Claide-${{ steps.version.outputs.version }}.dmg
          generate_release_notes: true
          tag_name: v${{ steps.version.outputs.version }}

      - name: Update Homebrew cask and appcast
        env:
          VERSION: ${{ steps.version.outputs.version }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          SPARKLE_EDDSA_KEY: ${{ secrets.SPARKLE_EDDSA_KEY }}
        run: |
          DMG_PATH="build/Claide-${VERSION}.dmg"
          SHA256=$(shasum -a 256 "$DMG_PATH" | awk '{print $1}')
          DMG_SIZE=$(stat -f%z "$DMG_PATH")
          DMG_URL="https://github.com/hex/Claide/releases/download/v${VERSION}/Claide-${VERSION}.dmg"

          # EdDSA signature for Sparkle
          EDDSA_SIG=$(echo "$SPARKLE_EDDSA_KEY" | sign_update "$DMG_PATH" -f -)
          SIG_VALUE=$(echo "$EDDSA_SIG" | sed 's/.*edSignature="\([^"]*\)".*/\1/')

          # Clone tap repo
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/hex/homebrew-claide.git" /tmp/tap
          cd /tmp/tap

          # Update cask formula
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/claide.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/claide.rb

          # Generate appcast entry
          PUB_DATE=$(date -R)
          cat > /tmp/new_item.xml << XMLEOF
              <item>
                <title>Version ${VERSION}</title>
                <pubDate>${PUB_DATE}</pubDate>
                <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
                <enclosure
                  url="${DMG_URL}"
                  sparkle:version="${VERSION}"
                  sparkle:shortVersionString="${VERSION}"
                  sparkle:edSignature="${SIG_VALUE}"
                  length="${DMG_SIZE}"
                  type="application/octet-stream"/>
              </item>
          XMLEOF

          # Insert new item after <language> line
          sed -i '' "/<language>en<\/language>/r /tmp/new_item.xml" appcast.xml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/claide.rb appcast.xml
          git commit -m "Update Claide to ${VERSION}"
          git push

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/build.keychain-db" 2>/dev/null || true
